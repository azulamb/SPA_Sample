<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<title>SPA sample 0</title>
	<script>
// SPAのシステムです。
class App {
	// SPAで更新するコンテンツを設定します。
	constructor( contents ) {
		// コンテンツを更新するHTML要素を持っておきます。
		this.contents = contents;

		// ページに来た初回のレンダリング周りの処理を行います。
		const pathname = ( sessionStorage.redirect || location.pathname ) + '';
		delete sessionStorage.redirect;

		this.baseurl = pathname.replace( /^(\/[^\/]+\/[^\/]+).*$/, '$1' );

		// ページのパスを取得します。
		const path = pathname.replace( /^\/[^\/]+\/[^\/]+(.*)$/, '$1' );

		// アドレスバーのURLを書き換えます。書き換えるだけなので履歴は残りません。
		history.replaceState( null, '', pathname );

		this.renderPage( path );
	}

	// データを元にコンテンツのレンダリングを行います。
	render( data ) {
		this.contents.textContent = data;
	}

	// パスを元にコンテンツのレンダリングを行います。
	renderPage( path ) {
		return Fetch( baseurl, path ).then( ( md ) => {
			this.render( md );
		} ).catch( ( error ) => {
			// 何かしらのエラーが発生しました。
			this.render( '# Error' );
		} );
	}

	// 目的のページに遷移します。
	gotoPage( path ) {
		// 履歴に追加します。
		history.pushState( null, '', path + '' );

		return this.renderPage( path );
	}

	// 目的のページに遷移する関数を作ります。
	jumpPage( path ) {
		return () => { this.gotoPage( path ); };
	}

	// リンクを探してページ遷移処理に書き換えます。
	convertAnchor( target )
	{
		// targetに指定がない場合は、document.bodyを指定します。
		if ( target === undefined ) { target = document.body }
		// ベースとなるURLを作ります。
		const baseurl = location.protocol + '//' + location.host + this.baseurl;
		// <a>を探します。
		const anchors = target.getElementsByTagName( 'a' );
		for ( let i= 0 ; i < anchors.length ; ++i )
		{
			// hrefが存在しないかonclickが設定されているかtargetが指定されている場合は無視します。
			if ( !anchors[ i ].href || anchors[ i ].onclick || anchors[ i ].target ) { continue; }
			// <a>のhrefはURLのフルパスが記載されているので、制御下のURLかどうか判定します。
			// URLがbaseurlから始まっていない場合は無視します。
			if ( anchors[ i ].href.indexOf( baseurl ) !== 0 ) { continue; }

			anchors[ i ].onclick = this.jumpPage( anchors[ i ].href.replace( baseurl, '' ) );
		}
	}
}

// コンテンツを取得します。
function Fetch( baseurl, path ) {
	// pathの簡易チェックを行います。
	if ( !path ) { path = '/'; }
	// pathの末尾が / の場合は index を追加します。
	if ( path.match( /\/$/ ) ) { path += 'index'; }
	// pathに .md を追加します。
	path += '.md';
	// fetch()を使いやすいようにラップします。
	return fetch( baseurl + path ).then( ( result ) => {
		// fetch()が失敗するのはネットワークトラブルなどであり、404エラーなどでは失敗扱いになりません。
		// そこで result.ok で結果がエラーでない場合は結果テキストを返し、そうでない場合は失敗扱いにします。
		if ( result.ok ) { return result.text(); }
		throw result;
	} );
}

// 初期化部分。
function Init() {
	// SPAの制御を行うクラスをインスタンス化します。
	const app = new App( document.getElementById( 'contents' ) );

	app.convertAnchor();
}

// document.getElementById() を使っても大丈夫になったら初期化関数を実行する。
document.addEventListener( 'DOMContentLoaded', Init );
	</script>
</head>
<body>
<pre id="contents"></pre>
<a href="./a">a.md</a>
</body>
</html>
